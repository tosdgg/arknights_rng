<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRTS // CONTINGENCY CONTRACT</title>
    <style>
        :root {
            --bg-color: #0d0d0d;
            --ak-yellow: #ffcd00; 
            --ak-cyan: #00e5ff;   
            --ak-red: #ff3e3e;
            --font-mono: 'Consolas', monospace;
        }
        body { margin: 0; background: var(--bg-color); color: #fff; font-family: sans-serif; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        /* 視覺裝飾：背景掃描線 */
        body::before {
            content: ""; position: fixed; inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%; z-index: 10; pointer-events: none;
        }

        .container { width: 95%; max-width: 1200px; height: 90vh; background: rgba(20,20,20,0.9); border: 1px solid #333; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 40px #000; }
        
        .header { height: 45px; background: #000; border-bottom: 2px solid var(--ak-yellow); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; font-family: var(--font-mono); }
        .header .status { color: var(--ak-cyan); font-size: 12px; text-shadow: 0 0 5px var(--ak-cyan); }

        .screen { padding: 40px; display: none; flex: 1; overflow-y: auto; }
        .screen.active { display: flex; flex-direction: column; animation: flick 0.2s; }
        @keyframes flick { 0% { opacity: 0.5; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* 難度與按鈕 */
        .diff-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-top: 40px; }
        .ak-card { background: #1a1a1a; border: 1px solid #444; padding: 30px 10px; cursor: pointer; text-align: center; transition: 0.2s; clip-path: polygon(0 15%, 15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%); }
        .ak-card:hover { background: var(--ak-yellow); color: #000; }

        .tag-btn { background: #2a2a2a; color: #aaa; border: none; padding: 10px 20px; cursor: pointer; font-family: var(--font-mono); font-weight: bold; clip-path: polygon(0 0, 90% 0, 100% 30%, 100% 100%, 0 100%); margin-right: 10px; margin-bottom: 10px; }
        .tag-btn.active { background: #eee; color: #000; }
        .tag-btn.exclusive { background: var(--ak-yellow) !important; color: #000 !important; box-shadow: 0 0 15px rgba(255,205,0,0.3); }

        .deploy-btn { background: var(--ak-red); color: #fff; padding: 20px 50px; border: none; font-weight: bold; cursor: pointer; font-size: 1.2rem; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%); margin-top: 20px; }
        .deploy-btn:hover { filter: brightness(1.2); transform: scale(1.02); }

        /* 結果卡片 */
        .result-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 30px; }
        .contract-card { background: #151515; border-left: 5px solid var(--ak-red); padding: 20px; position: relative; animation: slideIn 0.3s ease-out; }
        .contract-card.unique { border-left-color: var(--ak-yellow); background: rgba(255,205,0,0.05); }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } }

        .back-btn { background: transparent; border: 1px solid var(--ak-yellow); color: var(--ak-yellow); padding: 5px 15px; cursor: pointer; font-family: var(--font-mono); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>RHODES ISLAND // PRTS v5.0</div>
        <div id="top-nav" style="display:none;"><button class="back-btn" onclick="goBack()">RETURN</button></div>
        <div class="status">SYSTEM: ONLINE</div>
    </div>

    <div id="screen-difficulty" class="screen active">
        <h2 style="color:var(--ak-yellow); letter-spacing:3px;">>> SELECT RISK LEVEL</h2>
        <div class="diff-grid" id="diff-buttons"></div>
    </div>

    <div id="screen-selector" class="screen">
        <h2 id="level-display" style="margin:0; color:var(--ak-red);">RISK LEVEL 01</h2>
        <p style="color:#666; font-size:12px;">選擇標籤以生成合約限制：單擊包含(白)，雙擊唯一(黃)。</p>
        <div id="tag-container"></div>
        
        <div style="margin-top:20px;">
            <label style="font-family:var(--font-mono);">CONTRACT COUNT:</label>
            <input type="number" id="select-count" value="1" min="1" max="10" style="background:transparent; border:none; border-bottom:1px solid #fff; color:#fff; width:50px; text-align:center; font-size:1.2rem;">
            <br>
            <button class="deploy-btn" onclick="startSelection()">GENERATE CONTRACTS</button>
        </div>
        <div id="result-container" class="result-container"></div>
    </div>
</div>

<script>
    const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?output=csv";
    let allData = [];
    let currentLevelData = [];
    let tagStates = {};

    window.onload = async () => {
        try {
            const res = await fetch(GOOGLE_SHEET_URL);
            const text = await res.text();
            const rows = text.split(/\r?\n/).slice(1);
            allData = rows.map(r => {
                const c = r.split(',');
                return { name: c[0]?.trim(), diff: parseInt(c[1]), tag: c[2]?.trim() || "其他" };
            }).filter(i => i.name && !isNaN(i.diff));
            
            // 動態生成難度按鈕 (1-5)
            const diffGrid = document.getElementById('diff-buttons');
            for(let i=1; i<=5; i++) {
                const btn = document.createElement('div');
                btn.className = 'ak-card';
                btn.innerHTML = `<div style="font-size:0.8rem; color:#666;">RISK</div><div style="font-size:1.5rem; font-weight:bold;">0${i}</div>`;
                btn.onclick = () => selectDifficulty(i);
                diffGrid.appendChild(btn);
            }
        } catch (e) { alert("Data Load Error"); }
    };

    function selectDifficulty(lv) {
        currentLevelData = allData.filter(i => i.diff === lv);
        document.getElementById('screen-difficulty').classList.remove('active');
        document.getElementById('screen-selector').classList.add('active');
        document.getElementById('top-nav').style.display = 'block';
        document.getElementById('level-display').innerText = `RISK LEVEL 0${lv} CONFIGURATION`;
        
        tagStates = {};
        document.getElementById('result-container').innerHTML = '';
        
        // 提取標籤
        let rawTags = [];
        currentLevelData.forEach(item => { rawTags = rawTags.concat(item.tag.split(/\s+/)); });
        const tags = [...new Set(rawTags)].filter(t => t);

        const container = document.getElementById('tag-container');
        container.innerHTML = '';
        tags.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'tag-btn';
            btn.innerText = t;
            btn.onclick = () => {
                if (!tagStates[t]) { tagStates[t] = 1; btn.classList.add('active'); }
                else if (tagStates[t] === 1) { tagStates[t] = 2; btn.classList.remove('active'); btn.classList.add('exclusive'); }
                else { delete tagStates[t]; btn.classList.remove('exclusive'); }
            };
            container.appendChild(btn);
        });
    }

    function goBack() {
        document.getElementById('screen-selector').classList.remove('active');
        document.getElementById('screen-difficulty').classList.add('active');
        document.getElementById('top-nav').style.display = 'none';
        tagStates = {};
    }

    function hasTag(item, t) { return item.tag.split(/\s+/).includes(t); }

    function startSelection() {
        const count = parseInt(document.getElementById('select-count').value) || 1;
        const resContainer = document.getElementById('result-container');
        resContainer.innerHTML = '';
        
        let selectedPool = [];
        const exTags = Object.keys(tagStates).filter(k => tagStates[k] === 2);
        const normalTags = Object.keys(tagStates).filter(k => tagStates[k] === 1);

        // 核心邏輯：先滿足唯一標籤，再補齊普通標籤
        // 1. 唯一標籤 (每一類只出一個)
        exTags.forEach(t => {
            const matches = currentLevelData.filter(i => hasTag(i, t) && !selectedPool.includes(i));
            if (matches.length) {
                const pick = matches[Math.floor(Math.random() * matches.length)];
                pick._isUnique = true; // 標記為黃色來源
                selectedPool.push(pick);
            }
        });

        // 2. 普通標籤補充
        if (selectedPool.length < count) {
            let pool = [];
            if (normalTags.length === 0 && exTags.length === 0) {
                pool = currentLevelData;
            } else {
                pool = currentLevelData.filter(i => 
                    normalTags.some(t => hasTag(i, t)) && !selectedPool.includes(i)
                );
            }
            const extra = pool.sort(() => 0.5 - Math.random()).slice(0, count - selectedPool.length);
            selectedPool = [...selectedPool, ...extra];
        }

        // 渲染結果
        selectedPool.slice(0, count).forEach((item, idx) => {
            setTimeout(() => {
                const div = document.createElement('div');
                div.className = `contract-card ${item._isUnique ? 'unique' : ''}`;
                const badges = item.tag.split(/\s+/).map(t => `<span style="font-size:10px; color:var(--ak-cyan); margin-right:5px; border:1px solid #333; padding:1px 4px;">${t}</span>`).join('');
                div.innerHTML = `
                    <div style="font-family:var(--font-mono); font-size:10px; color:#666;">>> SOURCE: ${item._isUnique ? 'STRATEGIC' : 'TACTICAL'}</div>
                    <div style="font-weight:bold; font-size:1.2rem; margin:10px 0;">${item.name}</div>
                    <div>${badges}</div>
                `;
                resContainer.appendChild(div);
                delete item._isUnique; // 清除標記
            }, idx * 100);
        });
    }
</script>
</body>
</html>



