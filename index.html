<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRTS // TACTICAL TERMINAL v9.5</title>
    <style>
        :root {
            --ak-red: #ff3e3e; --ak-yellow: #ffcd00; --ak-cyan: #00e5ff; --bg-dark: #050505;
            --font-mono: 'Consolas', 'Courier New', monospace;
        }
        body, html { margin: 0; padding: 0; background: var(--bg-dark); color: #fff; font-family: var(--font-mono); overflow: hidden; height: 100vh; width: 100vw; }
        
        /* 3D 封面背景 */
        #screen-cover {
            position: fixed; inset: 0; z-index: 2000; background: var(--bg-dark);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .grid-3d {
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background-image: linear-gradient(var(--ak-red) 1px, transparent 1px), linear-gradient(90deg, var(--ak-red) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: perspective(500px) rotateX(60deg);
            opacity: 0.1; animation: gridMove 15s linear infinite;
        }
        @keyframes gridMove { from { transform: perspective(500px) rotateX(60deg) translateY(0); } to { transform: perspective(500px) rotateX(60deg) translateY(60px); } }

        .cover-content { position: relative; z-index: 1; text-align: center; }
        .cover-title { font-size: 5rem; letter-spacing: 15px; color: var(--ak-red); font-weight: 900; margin: 0; }
        .cover-sub { font-size: 1.2rem; letter-spacing: 8px; color: #888; margin-top: 10px; }
        .start-btn {
            margin-top: 50px; background: #000; color: var(--ak-red); border: 2px solid var(--ak-red);
            padding: 15px 60px; font-size: 1.2rem; cursor: pointer; transition: 0.3s;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
        }
        .start-btn:hover { background: var(--ak-red); color: #000; box-shadow: 0 0 30px var(--ak-red); }

        /* 主介面基礎結構 */
        .app-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; }
        .top-bar { height: 50px; background: #000; border-bottom: 2px solid var(--ak-red); display: flex; align-items: center; padding: 0 25px; justify-content: space-between; z-index: 1000; }
        .sidebar { position: fixed; left: -295px; top: 50px; bottom: 0; width: 315px; background: rgba(5, 5, 5, 0.95); border-right: 2px solid var(--ak-red); transition: 0.4s; z-index: 999; backdrop-filter: blur(10px); display: flex; flex-direction: column; }
        .sidebar:hover { left: 0; }
        .sidebar-handle { position: absolute; right: 0; top: 0; bottom: 0; width: 20px; background: repeating-linear-gradient(45deg, #000, #000 10px, var(--ak-red) 10px, var(--ak-red) 11px); cursor: pointer; opacity: 0.6; }
        .sidebar-content { flex: 1; padding: 20px; overflow-y: auto; }
        
        .main-screen { flex: 1; padding: 40px; overflow-y: auto; display: none; box-sizing: border-box; }
        .main-screen.active { display: block; }
        
        /* 難度卡片與合約卡片 */
        .diff-card { background: #111; border: 1px solid #333; height: 160px; cursor: pointer; position: relative; clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%); transition: 0.3s; }
        .diff-card:hover { border-color: var(--ak-red); transform: scale(1.02); }
        .contract-card { background: #0a0a0a; border: 1px solid #333; border-left: 6px solid var(--ak-red); padding: 20px; cursor: pointer; position: relative; margin-bottom: 10px; transition: 0.2s; }
        .contract-card.locked { border-left-color: var(--ak-cyan); background: #0a1820; border-color: var(--ak-cyan); }
        
        /* 按鈕與數值顯示 */
        .execute-btn { background: var(--ak-red); color: #fff; padding: 15px 40px; border: none; font-weight: bold; cursor: pointer; clip-path: polygon(5% 0, 100% 0, 95% 100%, 0% 100%); margin-right: 10px; }
        .execute-btn:disabled { opacity: 0.2; cursor: not-allowed; }
        #total-risk { font-size: 3rem; font-weight: 900; color: var(--ak-yellow); transition: 0.3s; }
        .risk-meter { height: 4px; width: 100%; background: #222; margin: 10px 0; position: relative; }
        #risk-fill { height: 100%; width: 0%; background: var(--ak-red); transition: 0.5s; }
        .slot-btn { flex: 1; background: #111; border: 1px solid #444; color: #666; font-size: 10px; padding: 5px; cursor: pointer; }
        .slot-btn.active { border-color: var(--ak-cyan); color: var(--ak-cyan); }
    </style>
</head>
<body>

<div id="screen-cover">
    <div class="grid-3d"></div>
    <div class="cover-content">
        <h1 class="cover-title">危機合約</h1>
        <div class="cover-sub">運氣與實力</div>
        
        <div style="margin-top: 40px; position: relative;">
            <a href="https://docs.google.com/document/d/e/2PACX-1vSgKnvH-feo3KlRU5xnuLhnwR8N3encMpYZRtDWaF3zrtuKeOk101pV2Ndw8J2KeTHLFamh8KFTjpVN/pub" target="_blank" class="guide-link">
                <span style="letter-spacing: 2px;">>> CONTRACT_GUIDE</span>
                <br>
                <span style="font-size: 1.2rem; font-weight: bold;">合約指南</span>
            </a>
        </div>

        <button class="start-btn" onclick="startSystem()">接受合約</button>
    </div>
</div>

<style>
    /* 合約指南專屬樣式 */
    .guide-link {
        display: inline-block;
        color: #666; 
        text-decoration: none; 
        transition: all 0.3s ease;
        padding: 10px 20px;
        border: 1px solid transparent;
    }
    
    .guide-link:hover {
        color: var(--ak-cyan);
        transform: translateY(-2px);
        text-shadow: 0 0 10px var(--ak-cyan);
    }

    /* 增加一個裝飾線效果 */
    .guide-link::after {
        content: '';
        display: block;
        width: 0;
        height: 1px;
        background: var(--ak-cyan);
        transition: width 0.3s;
        margin: 5px auto 0;
    }

    .guide-link:hover::after {
        width: 100%;
    }
</style>

<div class="app-wrapper">
    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:20px;">
            <span style="letter-spacing:3px; font-weight:bold; color:var(--ak-red);">PRTS // TERMINAL v9.5</span>
            <div id="back-zone" style="display:none;"><button onclick="goBack()" style="background:none; border:1px solid #444; color:#888; cursor:pointer; padding: 5px 15px;">RETURN</button></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-handle"></div>
        <div class="sidebar-content">
            <div style="font-size:10px; color:var(--ak-cyan);">MISSION_LOCATION</div>
            <div id="target-display" style="font-size:1.3rem; font-weight:bold; margin:10px 0; border-left:3px solid var(--ak-cyan); padding-left:10px; min-height:1.5em;">AWAITING_SIGNAL</div>
            <button onclick="acquireTarget()" style="width:100%; background:none; border:1px solid var(--ak-cyan); color:var(--ak-cyan); cursor:pointer; padding:5px; margin-bottom: 20px;">ACQUIRE_TARGET</button>
            <div style="font-size:14px; color:var(--ak-cyan); border-bottom:1px solid #333;">LOCKED_LIST</div>
            <div id="sidebar-list" style="margin-top: 10px;"></div>
        </div>
        <div style="padding: 20px; background: #050505; border-top: 1px solid #222;">
            <div style="font-size:10px; color:#888;">RISK_INDEX</div>
            <div class="risk-meter"><div id="risk-fill"></div></div>
            <div id="total-risk">00</div>
        </div>
        <div style="display: flex; gap: 5px; padding: 10px; background: #000;">
            <button class="slot-btn active" onclick="switchSlot(0)">SLOT_A</button>
            <button class="slot-btn" onclick="switchSlot(1)">SLOT_B</button>
            <button class="slot-btn" onclick="switchSlot(2)">SLOT_C</button>
        </div>
    </div>

    <div id="screen-diff" class="main-screen">
        <h1 style="font-size:2rem; letter-spacing:8px; border-left: 5px solid var(--ak-red); padding-left: 15px;">MISSION_CONTROL</h1>
        <div id="diff-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 50px;"></div>
    </div>

    <div id="screen-draw" class="main-screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 30px;">
            <h2 id="current-lv-label" style="margin:0; color:var(--ak-red); font-size: 2rem;">LV.01</h2>
            <div style="color:#555;">QTY: <input type="number" id="draw-count" readonly style="background:none; border:none; color:var(--ak-red); font-size: 1.5rem; width: 40px; text-align: center;"></div>
        </div>
        <div style="margin-bottom: 30px;">
            <button id="btn-scan" class="execute-btn" onclick="executeScan(false)">NEURAL_SCAN</button>
            <button id="btn-rescan" class="execute-btn" onclick="executeScan(true)" style="background:none; border:1px solid #555; color: #888;">RE-SCAN</button>
        </div>
        <div id="result-zone" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;"></div>
    </div>
</div>
<script>
    const CONTRACT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?gid=0&output=csv";
    const LOCATION_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?gid=754158994&output=csv";

    let db_contracts = [], db_locations = [];
    let state_slots = [[], [], []], current_slot_idx = 0;
    
    // --- v9.52 新增：跨難度狀態追蹤 ---
    // 用於記錄每個 Slot(3個) 裡面每個難度(5級) 的隨機結果與重抽次數
    let state_history = [
        { results: {1:[],2:[],3:[],4:[],5:[]}, rescans: {1:0,2:0,3:0,4:0,5:0} },
        { results: {1:[],2:[],3:[],4:[],5:[]}, rescans: {1:0,2:0,3:0,4:0,5:0} },
        { results: {1:[],2:[],3:[],4:[],5:[]}, rescans: {1:0,2:0,3:0,4:0,5:0} }
    ];

    let current_lv = 0, state_map_risk = 0;
    const LV_QTY_MAP = { 1: 10, 2: 8, 3: 8, 4: 5, 5: 4 };

    window.onload = async () => { await initSystem(); };

    async function initSystem() {
        try {
            const [cRes, lRes] = await Promise.all([fetch(CONTRACT_URL), fetch(LOCATION_URL)]);
            const cText = await cRes.text(), lText = await lRes.text();
            db_contracts = cText.split(/\r?\n/).slice(1).map((r, idx) => {
                const cols = r.split(',');
                return { name: cols[0]?.trim(), diff: parseInt(cols[1]), row: idx + 2 };
            }).filter(i => i.name && !isNaN(i.diff));
            db_locations = lText.split(/\r?\n/).slice(1).map(r => {
                const cols = r.split(',');
                return { name: cols[0]?.trim(), risk: parseInt(cols[1]) || 0 };
            }).filter(i => i.name);
        } catch (e) { console.error("PRTS: SYNC_ERROR"); }
    }

    function startSystem() {
        document.getElementById('screen-cover').style.display = 'none';
        document.getElementById('screen-diff').classList.add('active');
        renderDifficultyCards();
    }

    function renderDifficultyCards() {
        const container = document.getElementById('diff-container');
        container.innerHTML = '';
        for(let i=1; i<=5; i++) {
            const score = state_slots[current_slot_idx].filter(it => it.diff === i).reduce((s, it) => s + it.diff, 0);
            const card = document.createElement('div');
            card.className = 'diff-card';
            card.innerHTML = `
                <div style="font-size:4rem; font-weight:900; color:var(--ak-red); position:absolute; bottom:5px; right:15px; opacity:0.1;">0${i}</div>
                <div style="padding:20px;">
                    <div style="font-size:10px; color:#666;">LV.0${i}_ACCUMULATED</div>
                    <div style="font-size:2rem; font-weight:bold; color:${score>0?'var(--ak-red)':(score<0?'var(--ak-cyan)':'#444')}">${score!==0?(score>0?'+'+score:score):'---'}</div>
                </div>
            `;
            card.onclick = () => enterLevel(i);
            container.appendChild(card);
        }
    }

    function enterLevel(lv) {
        current_lv = lv;
        const hist = state_history[current_slot_idx];
        
        document.getElementById('screen-diff').classList.remove('active');
        document.getElementById('screen-draw').classList.add('active');
        document.getElementById('back-zone').style.display = 'block';
        document.getElementById('current-lv-label').innerText = `RISK_LEVEL_0${lv}`;
        document.getElementById('draw-count').value = LV_QTY_MAP[lv];

        // 恢復之前的隨機結果
        if (hist.results[lv].length > 0) {
            // 如果這難度之前抽過，顯示當時的結果
            renderResultGrid(hist.results[lv]);
            // 並且如果已經點過 NEURAL_SCAN，鎖定按鈕
            document.getElementById('btn-scan').disabled = true;
        } else {
            // 如果是全新的難度，清空畫面並恢復按鈕
            document.getElementById('result-zone').innerHTML = '';
            document.getElementById('btn-scan').disabled = false;
        }
        updateSidebarUI();
    }

    function executeScan(isReroll) {
        const hist = state_history[current_slot_idx];
        
        if (!isReroll) {
            document.getElementById('btn-scan').disabled = true;
            hist.rescans[current_lv] = 0;
        } else {
            hist.rescans[current_lv]++;
        }

        const qty = LV_QTY_MAP[current_lv];
        // 找出目前「畫面中」被「鎖定到 SLOT」的合約
        let lockedInCurrent = hist.results[current_lv].filter(i => state_slots[current_slot_idx].some(s => s.row === i.row));
        
        // 從資料庫抽取，排除「已經被任何難度鎖定」的合約
        let pool = db_contracts.filter(i => i.diff === current_lv && !state_slots[current_slot_idx].some(s => s.row === i.row))
                     .sort(() => 0.5 - Math.random())
                     .slice(0, Math.max(0, qty - lockedInCurrent.length));
        
        // 更新歷史紀錄
        hist.results[current_lv] = [...lockedInCurrent, ...pool];
        
        renderResultGrid(hist.results[current_lv]);
        updateSidebarUI();
    }

    function renderResultGrid(items) {
        const zone = document.getElementById('result-zone');
        zone.innerHTML = '';
        items.forEach(item => {
            const isLocked = state_slots[current_slot_idx].some(s => s.row === item.row);
            const card = document.createElement('div');
            card.className = `contract-card ${isLocked ? 'locked' : ''}`;
            card.innerHTML = `
                <div style="font-size:10px; color:#555;">>> ROW-${item.row} ${isLocked?'[LOCKED]':''}</div>
                <div style="font-weight:bold; margin-top:5px;">${item.name}</div>
            `;
            card.onclick = () => {
                let s = state_slots[current_slot_idx];
                let idx = s.findIndex(l => l.row === item.row);
                if(idx > -1) s.splice(idx, 1); else s.push(item);
                renderResultGrid(items); // 重新渲染當前畫面以更新鎖定樣式
                updateSidebarUI();
            };
            zone.appendChild(card);
        });
    }

    function updateSidebarUI() {
        const list = document.getElementById('sidebar-list');
        list.innerHTML = '';
        let contractTotal = 0;
        state_slots[current_slot_idx].sort((a,b)=>a.diff-b.diff).forEach(i => {
            contractTotal += i.diff;
            list.innerHTML += `<div style="font-size:11px; padding:4px 0; border-bottom:1px solid #222;"><span style="color:var(--ak-red)">[LV.${i.diff}]</span> ${i.name}</div>`;
        });

        // 彙總所有難度的重抽次數
        let totalRescanBonus = 0;
        const hist = state_history[current_slot_idx];
        for(let lv in hist.rescans) {
            let count = hist.rescans[lv];
            if(count > 0) totalRescanBonus += -Math.pow(2, count - 1);
        }
        
        let final = contractTotal + state_map_risk + totalRescanBonus;
        const riskVal = document.getElementById('total-risk');
        riskVal.innerText = final < 0 ? final : final.toString().padStart(2, '0');
        riskVal.style.color = final < 0 ? "var(--ak-cyan)" : "var(--ak-yellow)";
        
        if(totalRescanBonus !== 0) {
            riskVal.innerHTML += `<span style="font-size:12px; color:#555; margin-left:10px;">RESCAN_BONUS: ${totalRescanBonus}</span>`;
        }
        document.getElementById('risk-fill').style.width = Math.max(0, Math.min(100, (final/30)*100)) + "%";
    }

    function switchSlot(idx) {
        current_slot_idx = idx;
        document.querySelectorAll('.slot-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
        updateSidebarUI();
        if(document.getElementById('screen-diff').classList.contains('active')) renderDifficultyCards();
    }

    function goBack() {
        document.getElementById('screen-draw').classList.remove('active');
        document.getElementById('screen-diff').classList.add('active');
        document.getElementById('back-zone').style.display = 'none';
        renderDifficultyCards();
    }
    // 確保 HTML 按鈕是這樣寫的：
// <button onclick="acquireTarget()" ...>ACQUIRE_TARGET</button>

function acquireTarget() {
    if (db_locations.length === 0) {
        alert("[PRTS_ERROR] 尚未同步地圖數據庫，請稍後。");
        return;
    }
    
    // 隨機抽取地圖
    const roll = db_locations[Math.floor(Math.random() * db_locations.length)];
    
    // 更新介面顯示
    const targetDisplay = document.getElementById('target-display');
    targetDisplay.innerText = roll.name;
    targetDisplay.style.color = "var(--ak-cyan)";
    
    // 儲存地圖風險值
    state_map_risk = roll.risk;
    
    // 播放一個簡單的閃爍特效
    targetDisplay.style.animation = "none";
    targetDisplay.offsetHeight; // 觸發重繪
    targetDisplay.style.animation = "alert-pulse 0.5s ease-out";
    
    // 關鍵：更新側邊欄總分
    updateSidebarUI();
    }
</script>
</body>
</html>



