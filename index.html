<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>PRTS 終端 v9.3 - 戰術模擬器</title>
    <style>
        :root { --prts-blue: #00BAFF; --prts-bg: #121212; --prts-card: #1E1E1E; }
        body { background: var(--prts-bg); color: white; font-family: "Segoe UI", sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; overflow-x: hidden; }
        
        /* UI 佈局保持原樣 */
        #header { width: 100%; padding: 20px; background: rgba(0,0,0,0.8); border-bottom: 2px solid var(--prts-blue); display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        #risk-display { font-size: 2.5rem; color: var(--prts-blue); font-weight: bold; text-shadow: 0 0 10px var(--prts-blue); }
        
        #main-container { display: flex; gap: 20px; padding: 20px; width: 95%; max-width: 1200px; }
        #contract-area { flex: 2; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        #control-panel { flex: 1; background: var(--prts-card); padding: 20px; border-radius: 8px; border: 1px solid #333; height: fit-content; }
        
        .contract-card { background: #2A2A2A; border: 1px solid #444; padding: 15px; border-radius: 4px; transition: 0.3s; cursor: pointer; }
        .contract-card.selected { border-color: var(--prts-blue); background: #2A3540; box-shadow: inset 0 0 10px rgba(0,186,255,0.2); }
        .level-tag { float: right; padding: 2px 8px; background: #444; border-radius: 10px; font-size: 0.8rem; }
        
        button { background: transparent; border: 1px solid var(--prts-blue); color: var(--prts-blue); padding: 10px 20px; cursor: pointer; transition: 0.3s; width: 100%; margin-top: 10px; font-weight: bold; }
        button:hover { background: var(--prts-blue); color: black; }
        
        #target-display { font-size: 1.5rem; margin: 15px 0; color: #FFD700; border: 1px dashed #555; padding: 10px; text-align: center; }
    </style>
</head>
<body>

<div id="header">
    <div>PRTS TERMINAL v9.3 - STRATEGIC OVERRIDE</div>
    <div id="risk-display">TOTAL RISK: <span id="risk-index">0</span></div>
</div>

<div id="main-container">
    <div id="contract-area">
        </div>

    <div id="control-panel">
        <h3>戰場定位 (LOCATION)</h3>
        <div id="target-display">等待掃描...</div>
        <button onclick="acquireTarget()">ACQUIRE TARGET</button>
        
        <hr style="border: 0.5px solid #444; margin: 20px 0;">
        
        <h3>系統操作 (SYSTEM)</h3>
        <button onclick="shuffleContracts()">RE-SCAN CONTRACTS</button>
        <button onclick="resetSystem()" style="border-color: #ff4444; color: #ff4444;">RESET SYSTEM</button>
    </div>
</div>

<script>
    // 博士的試算表配置
    const CONTRACT_URL = "https://docs.google.com/spreadsheets/d/1vP4S0eLnd_u5-K8-C6wAInyP6iSipBwN6DclT-XmR6M/export?format=csv&gid=0";
    const LOCATION_URL = "https://docs.google.com/spreadsheets/d/1vP4S0eLnd_u5-K8-C6wAInyP6iSipBwN6DclT-XmR6M/export?format=csv&gid=754158994";

    let allContracts = [];
    let selectedContracts = [];
    let currentMapRisk = 0; // 核心：紀錄地圖 B 欄的正負分

    // 初始化系統
    async function init() {
        await fetchContracts();
        shuffleContracts();
    }

    // 抓取合約資料 (Sheet 1)
    async function fetchContracts() {
        try {
            const response = await fetch(CONTRACT_URL);
            const data = await response.text();
            const rows = data.split('\n').slice(1); // 略過標題
            allContracts = rows.map(row => {
                const cols = row.split(',');
                return { name: cols[0], level: parseInt(cols[1]) || 0, tag: cols[2] };
            }).filter(c => c.name);
        } catch (e) { console.error("合約讀取失敗"); }
    }

    // 隨機抽取 12 個合約 (包含第 4、5 等級)
    function shuffleContracts() {
        const area = document.getElementById('contract-area');
        area.innerHTML = '';
        selectedContracts = [];
        
        const shuffled = allContracts.sort(() => 0.5 - Math.random()).slice(0, 12);
        shuffled.forEach(c => {
            const card = document.createElement('div');
            card.className = 'contract-card';
            card.innerHTML = `<span class="level-tag">LV ${c.level}</span><div>${c.name}</div><small style="color:#888">${c.tag || ''}</small>`;
            card.onclick = () => toggleContract(card, c);
            area.appendChild(card);
        });
        updateTotalRisk();
    }

    // 切換選中狀態
    function toggleContract(dom, contract) {
        const index = selectedContracts.indexOf(contract);
        if (index > -1) {
            selectedContracts.splice(index, 1);
            dom.classList.remove('selected');
        } else {
            selectedContracts.push(contract);
            dom.classList.add('selected');
        }
        updateTotalRisk();
    }

    // 核心功能：抽取關卡並讀取 B 欄數值
    async function acquireTarget() {
        try {
            const response = await fetch(LOCATION_URL);
            const data = await response.text();
            // 處理 CSV 換行與逗號，移除可能的雙引號
            const rows = data.split('\n').filter(r => r.trim()).map(row => row.split(','));
            
            // 隨機選取關卡（跳過標題）
            const randomIndex = Math.floor(Math.random() * (rows.length - 1)) + 1;
            const selectedRow = rows[randomIndex];

            const mapName = selectedRow[0].replace(/"/g, '').trim();
            // 讀取 B 欄分數，並處理負號與空格
            currentMapRisk = parseInt(selectedRow[1]) || 0;

            document.getElementById('target-display').innerText = mapName;
            
            // 更新總分
            updateTotalRisk();
        } catch (e) { 
            document.getElementById('target-display').innerText = "通訊異常";
            console.error("地圖讀取失敗", e); 
        }
    }

    // 更新總分 (合約等級 + 地圖權重)
    function updateTotalRisk() {
        let contractScore = 0;
        selectedContracts.forEach(c => contractScore += c.level);
        
        // 最終計算
        const finalTotal = contractScore + currentMapRisk;
        
        // 更新 UI
        document.getElementById('risk-index').innerText = finalTotal;
    }

    function resetSystem() {
        currentMapRisk = 0;
        document.getElementById('target-display').innerText = "等待掃描...";
        shuffleContracts();
    }

    window.onload = init;
</script>

</body>
</html>
