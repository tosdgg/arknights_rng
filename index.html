<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRTS // CRISIS_CONTRACT v9.5</title>
    <style>
        :root {
            --ak-red: #ff3e3e; --ak-yellow: #ffcd00; --ak-cyan: #00e5ff; --bg-dark: #050505;
            --font-mono: 'Consolas', 'Courier New', monospace;
        }
        body, html { margin: 0; padding: 0; background: var(--bg-dark); color: #fff; font-family: var(--font-mono); overflow: hidden; height: 100vh; width: 100vw; }
        
        /* 3D 背景特效 */
        .bg-fx { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, #220000 0%, #050505 100%); }
        .grid-3d {
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background-image: linear-gradient(var(--ak-red) 1px, transparent 1px), linear-gradient(90deg, var(--ak-red) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: perspective(500px) rotateX(60deg) translateY(0);
            opacity: 0.15; animation: gridMove 10s linear infinite;
        }
        @keyframes gridMove { from { transform: perspective(500px) rotateX(60deg) translateY(0); } to { transform: perspective(500px) rotateX(60deg) translateY(60px); } }

        .app-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; }
        
        /* 封面樣式 */
        #screen-cover {
            position: absolute; inset: 0; z-index: 2000; background: var(--bg-dark);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .cover-title { font-size: 5rem; letter-spacing: 15px; color: var(--ak-red); font-weight: 900; text-shadow: 0 0 20px rgba(255,62,62,0.5); margin: 0; }
        .cover-sub { font-size: 1.2rem; letter-spacing: 8px; color: #888; margin-top: 10px; }
        .start-btn {
            margin-top: 50px; background: #000; color: var(--ak-red); border: 2px solid var(--ak-red);
            padding: 15px 60px; font-size: 1.2rem; cursor: pointer; transition: 0.3s;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
        }
        .start-btn:hover { background: var(--ak-red); color: #000; box-shadow: 0 0 30px var(--ak-red); }

        /* 介面樣式保持 9.2-9.4 特色 */
        .top-bar { height: 50px; background: #000; border-bottom: 2px solid var(--ak-red); display: flex; align-items: center; padding: 0 25px; justify-content: space-between; z-index: 1000; }
        .sidebar { position: fixed; left: -295px; top: 50px; bottom: 0; width: 315px; background: rgba(5, 5, 5, 0.95); border-right: 2px solid var(--ak-red); transition: 0.4s; z-index: 999; backdrop-filter: blur(10px); display: flex; flex-direction: column; }
        .sidebar:hover { left: 0; }
        .sidebar-handle { position: absolute; right: 0; top: 0; bottom: 0; width: 20px; background: repeating-linear-gradient(45deg, #000, #000 10px, var(--ak-red) 10px, var(--ak-red) 11px); cursor: pointer; opacity: 0.6; }
        .sidebar-content { flex: 1; padding: 20px; overflow-y: auto; }
        .risk-meter { height: 4px; width: 100%; background: #222; margin: 10px 0; position: relative; }
        #risk-fill { height: 100%; width: 0%; background: var(--ak-red); transition: 0.5s; box-shadow: 0 0 10px var(--ak-red); }
        .slot-zone { display: flex; gap: 5px; padding: 10px 20px; background: #000; border-top: 1px solid #333; }
        .slot-btn { flex: 1; background: #111; border: 1px solid #444; color: #666; font-size: 10px; padding: 5px; cursor: pointer; }
        .slot-btn.active { border-color: var(--ak-cyan); color: var(--ak-cyan); }
        .main-screen { flex: 1; padding: 40px; overflow-y: auto; display: none; box-sizing: border-box; }
        .main-screen.active { display: block; }
        .diff-card { background: #111; border: 1px solid #333; height: 160px; cursor: pointer; position: relative; clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%); transition: 0.3s; }
        .diff-card:hover { border-color: var(--ak-red); transform: scale(1.05); }
        .contract-card { background: #0a0a0a; border: 1px solid #333; border-left: 6px solid var(--ak-red); padding: 20px; cursor: pointer; position: relative; }
        .contract-card.locked { border-left-color: var(--ak-cyan); background: #0a1820; border-color: var(--ak-cyan); }
        .execute-btn { background: var(--ak-red); color: #fff; padding: 15px 40px; border: none; font-weight: bold; cursor: pointer; clip-path: polygon(5% 0, 100% 0, 95% 100%, 0% 100%); margin-right: 10px; }
        .execute-btn:disabled { opacity: 0.2; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="screen-cover">
    <div class="grid-3d"></div>
    <h1 class="cover-title">危機合約</h1>
    <div class="cover-sub">運氣與實力</div>
    <button class="start-btn" onclick="startSystem()">接受合約</button>
</div>

<div class="app-wrapper">
    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:20px;">
            <span style="letter-spacing:3px; font-weight:bold; color:var(--ak-red);">PRTS // TERMINAL v9.5</span>
            <div id="back-zone" style="display:none;"><button onclick="goBack()" style="background:none; border:1px solid #444; color:#888; cursor:pointer;">RETURN</button></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-handle"></div>
        <div class="sidebar-content">
            <div style="font-size:10px; color:var(--ak-cyan);">MISSION_LOCATION</div>
            <div id="target-display" style="font-size:1.3rem; font-weight:bold; margin:10px 0; border-left:3px solid var(--ak-cyan); padding-left:10px; min-height:1.5em;">AWAITING_SIGNAL</div>
            <button class="locate-btn" onclick="acquireTarget()" style="width:100%; background:none; border:1px solid var(--ak-cyan); color:var(--ak-cyan); cursor:pointer; padding:5px;">ACQUIRE_TARGET</button>
            <div style="font-size:14px; color:var(--ak-cyan); margin-top:20px; border-bottom:1px solid #333;">LOCKED_LIST</div>
            <div id="sidebar-list"></div>
        </div>
        <div style="padding: 20px; background: #050505;">
            <div style="font-size:10px; color:#888;">RISK_INDEX</div>
            <div class="risk-meter"><div id="risk-fill"></div></div>
            <div style="font-size:2.8rem; font-weight:900; color:var(--ak-yellow);" id="total-risk">00</div>
        </div>
        <div class="slot-zone">
            <button class="slot-btn active" onclick="switchSlot(0)">SLOT_A</button>
            <button class="slot-btn" onclick="switchSlot(1)">SLOT_B</button>
            <button class="slot-btn" onclick="switchSlot(2)">SLOT_C</button>
        </div>
    </div>

    <div id="screen-diff" class="main-screen">
        <h1 style="font-size:2rem; letter-spacing:8px;">MISSION_CONTROL</h1>
        <div id="diff-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 50px;"></div>
    </div>

    <div id="screen-draw" class="main-screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 30px;">
            <h2 id="current-lv-label" style="margin:0; color:var(--ak-red);">LV.01</h2>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:12px; color:#555;">QTY</span>
                <input type="number" id="draw-count" value="1" readonly style="background:none; border:none; border-bottom:2px solid #555; color:#888; width:40px; text-align:center; font-size:1.2rem;">
            </div>
        </div>
        <button id="btn-scan" class="execute-btn" onclick="executeScan(false)">NEURAL_SCAN</button>
        <button id="btn-rescan" class="execute-btn" onclick="executeScan(true)" style="background:none; border:1px solid #555;">RE-SCAN</button>
        <div id="result-zone" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 30px;"></div>
    </div>
</div>

<script>
    const CONTRACT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?gid=0&output=csv";
    const LOCATION_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?gid=754158994&output=csv";

    let db_contracts = [];
    let db_locations = [];
    let state_current_level_items = [];
    let state_slots = [[], [], []], current_slot_idx = 0;
    let current_results = [];
    let current_lv = 0, rescan_count = 0, state_map_risk = 0;
    const LV_QTY_MAP = { 1: 10, 2: 8, 3: 8, 4: 5, 5: 4 };

    window.onload = async () => { await initSystem(); };

    async function initSystem() {
        try {
            const [cRes, lRes] = await Promise.all([fetch(CONTRACT_URL), fetch(LOCATION_URL)]);
            const cText = await cRes.text(), lText = await lRes.text();
            db_contracts = cText.split(/\r?\n/).slice(1).map((r, idx) => {
                const cols = r.split(',');
                return { name: cols[0]?.trim(), diff: parseInt(cols[1]), tag: cols[2]?.trim() || "其他", row: idx + 2 };
            }).filter(i => i.name && !isNaN(i.diff));
            db_locations = lText.split(/\r?\n/).slice(1).map(r => {
                const cols = r.split(',');
                return { name: cols[0]?.trim(), risk: parseInt(cols[1]) || 0 };
            }).filter(i => i.name);
        } catch (e) { console.error("PRTS: Failed."); }
    }

    function startSystem() {
        document.getElementById('screen-cover').style.display = 'none';
        document.getElementById('screen-diff').classList.add('active');
        renderDifficultyCards();
    }

    function renderDifficultyCards() {
        const container = document.getElementById('diff-container');
        container.innerHTML = '';
        for(let i=1; i<=5; i++) {
            const card = document.createElement('div');
            card.className = 'diff-card';
            const score = state_slots[current_slot_idx].filter(it => it.diff === i).reduce((s, it) => s + it.diff, 0);
            const sColor = score > 0 ? 'var(--ak-red)' : (score < 0 ? 'var(--ak-cyan)' : '#444');
            card.innerHTML = `
                <div style="font-size:4rem; font-weight:900; color:var(--ak-red); position:absolute; bottom:5px; right:15px; opacity:0.1;">0${i}</div>
                <div style="position:absolute; top:15px; left:15px; font-size:10px; color:#666;">LV.0${i}_ACCUMULATED</div>
                <div style="position:absolute; top:30px; left:15px; font-size:1.8rem; font-weight:bold; color:${sColor}">${score !== 0 ? (score>0?`+${score}`:score) : '---'}</div>
            `;
            card.onclick = () => enterLevel(i);
            container.appendChild(card);
        }
    }

    function enterLevel(lv) {
        current_lv = lv; rescan_count = 0;
        state_current_level_items = db_contracts.filter(i => i.diff === lv);
        document.getElementById('screen-diff').classList.remove('active');
        document.getElementById('screen-draw').classList.add('active');
        document.getElementById('back-zone').style.display = 'block';
        document.getElementById('current-lv-label').innerText = `RISK_LEVEL_0${lv}`;
        document.getElementById('draw-count').value = LV_QTY_MAP[lv];
        document.getElementById('btn-scan').disabled = false;
        document.getElementById('result-zone').innerHTML = '';
        current_results = [];
    }

    function executeScan(isReroll) {
        if (!isReroll) { document.getElementById('btn-scan').disabled = true; rescan_count = 0; }
        else { rescan_count++; }

        const count = LV_QTY_MAP[current_lv];
        let lockedInCurrent = current_results.filter(i => state_slots[current_slot_idx].some(s => s.row === i.row));
        let candidates = state_current_level_items.filter(i => !state_slots[current_slot_idx].some(s => s.row === i.row));
        const pool = candidates.sort(() => 0.5 - Math.random()).slice(0, Math.max(0, count - lockedInCurrent.length));
        
        current_results = [...lockedInCurrent, ...pool];
        renderResultGrid(current_results, !isReroll);
        updateSidebarUI();
    }

    function updateSidebarUI() {
        const list = document.getElementById('sidebar-list');
        list.innerHTML = '';
        let contractTotal = 0;
        state_slots[current_slot_idx].sort((a,b)=>a.diff-b.diff).forEach(i => {
            contractTotal += i.diff;
            const d = document.createElement('div');
            d.style = "font-size:11px; padding:5px 0; border-bottom:1px solid #222;";
            d.innerHTML = `<span style="color:var(--ak-red)">[LV.${i.diff}]</span> ${i.name}`;
            list.appendChild(d);
        });

        let penalty = rescan_count > 0 ? -Math.pow(2, rescan_count - 1) : 0;
        const finalTotal = contractTotal + state_map_risk + penalty;
        const riskVal = document.getElementById('total-risk');
        riskVal.innerText = finalTotal < 0 ? finalTotal : finalTotal.toString().padStart(2, '0');
        riskVal.style.color = finalTotal < 0 ? "var(--ak-cyan)" : "var(--ak-yellow)";
        if(rescan_count > 0) riskVal.innerHTML += `<span style="font-size:10px; color:#555; margin-left:10px;">(RESCAN: ${penalty})</span>`;
        document.getElementById('risk-fill').style.width = Math.max(0, Math.min(100, (finalTotal / 30) * 100)) + "%";
    }

    function renderResultGrid(items, animate) {
        const zone = document.getElementById('result-zone');
        zone.innerHTML = '';
        items.forEach((item, idx) => {
            const isLocked = state_slots[current_slot_idx].some(s => s.row === item.row);
            const card = document.createElement('div');
            card.className = `contract-card ${isLocked ? 'locked' : ''}`;
            card.innerHTML = `<div style="font-size:10px; color:#555;">>> ROW-${item.row} <span>${isLocked?'[LOCKED]':''}</span></div><div style="font-weight:bold; margin:10px 0;">${item.name}</div>`;
            card.onclick = () => {
                let s = state_slots[current_slot_idx];
                let i = s.findIndex(l => l.row === item.row);
                if(i > -1) s.splice(i, 1); else s.push(item);
                renderResultGrid(current_results, false);
                updateSidebarUI();
            };
            zone.appendChild(card);
        });
    }

    function switchSlot(idx) {
        current_slot_idx = idx;
        document.querySelectorAll('.slot-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
        updateSidebarUI();
        if(document.getElementById('screen-diff').classList.contains('active')) renderDifficultyCards();
    }

    function acquireTarget() {
        const roll = db_locations[Math.floor(Math.random() * db_locations.length)];
        document.getElementById('target-display').innerText = roll.name;
        state_map_risk = roll.risk;
        updateSidebarUI();
    }

    function goBack() {
        document.getElementById('screen-draw').classList.remove('active');
        document.getElementById('screen-diff').classList.add('active');
        document.getElementById('back-zone').style.display = 'none';
        renderDifficultyCards();
    }
</script>
</body>
</html>

