// --- 核心數據節點 ---
    const CONTRACT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?gid=0&output=csv";
    const LOCATION_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?gid=754158994&output=csv";

    let db_contracts = [];
    let db_locations = [];
    let state_map_risk = 0;
    let state_current_level_items = [], state_tags = {};
    let state_slots = [[], [], []], current_slot_idx = 0;
    let current_results = [];
    
    // --- v9.4 新增狀態變數 ---
    let current_lv = 0;
    let rescan_count = 0; // 當前難度的重抽次數
    const LV_QTY_MAP = { 1: 10, 2: 8, 3: 8, 4: 5, 5: 4 }; // 等級對應數量

    window.onload = async () => {
        await initSystem();
        renderDifficultyCards();
    };

    async function initSystem() {
        try {
            const [cRes, lRes] = await Promise.all([fetch(CONTRACT_URL), fetch(LOCATION_URL)]);
            const cText = await cRes.text();
            const lText = await lRes.text();

            db_contracts = cText.split(/\r?\n/).slice(1).map((r, idx) => {
                const cols = r.split(',');
                return { name: cols[0]?.trim(), diff: parseInt(cols[1]), tag: cols[2]?.trim() || "其他", row: idx + 2 };
            }).filter(i => i.name && !isNaN(i.diff));

            db_locations = lText.split(/\r?\n/).slice(1).map(r => {
                const cols = r.split(',');
                return { name: cols[0]?.trim(), risk: parseInt(cols[1]) || 0 };
            }).filter(i => i.name);
        } catch (e) { console.error("PRTS: Sync Failed."); }
    }

    function enterLevel(lv) {
        current_lv = lv;
        rescan_count = 0; // 重置重抽次數
        state_current_level_items = db_contracts.filter(i => i.diff === lv);
        
        document.getElementById('screen-diff').classList.remove('active');
        document.getElementById('screen-draw').classList.add('active');
        document.getElementById('back-zone').style.display = 'block';
        document.getElementById('current-lv-label').innerText = `RISK_LEVEL_0${lv}`;
        
        // 恢復按鈕狀態
        document.querySelector('.execute-btn[onclick*="false"]').disabled = false;
        document.querySelector('.execute-btn[onclick*="false"]').style.opacity = "1";

        renderTagButtons();
        // 進入後不自動抽，等待博士點擊 NEURAL_SCAN
        document.getElementById('result-zone').innerHTML = '<div style="color:#444; grid-column: 1/-1; text-align:center; padding:50px;">AWAITING_NEURAL_CONNECT...</div>';
    }

    function calculateRescanPenalty(count) {
        if (count === 0) return 0;
        if (count === 1) return -1; // 第一次重抽：-1
        return Math.pow(2, count - 2); // 之後：0, 1, 2, 4, 8...
    }

    function executeScan(isReroll) {
        const count = LV_QTY_MAP[current_lv] || 1;
        
        if (!isReroll) {
            // NEURAL_SCAN: 執行後鎖定
            document.querySelector('.execute-btn[onclick*="false"]').disabled = true;
            document.querySelector('.execute-btn[onclick*="false"]').style.opacity = "0.3";
            rescan_count = 0;
        } else {
            // RE-SCAN: 累計次數
            rescan_count++;
        }

        let lockedInCurrent = current_results.filter(i => state_slots[current_slot_idx].some(s => s.row === i.row));
        const needed = count - lockedInCurrent.length;

        const exclusiveTags = Object.keys(state_tags).filter(k => state_tags[k] === 2);
        const normalTags = Object.keys(state_tags).filter(k => state_tags[k] === 1);

        let candidates = state_current_level_items.filter(i => {
            const itemTags = i.tag.split(/\s+/);
            return !exclusiveTags.some(t => itemTags.includes(t)) && 
                   !state_slots[current_slot_idx].some(s => s.row === i.row);
        });

        if(normalTags.length > 0) candidates = candidates.filter(i => normalTags.some(t => i.tag.split(/\s+/).includes(t)));
        
        const pool = candidates.sort(() => 0.5 - Math.random()).slice(0, Math.max(0, needed));
        current_results = [...lockedInCurrent, ...pool];
        
        renderResultGrid(current_results, !isReroll);
        updateSidebarUI();
    }

    function updateSidebarUI() {
        const list = document.getElementById('sidebar-list');
        const riskFill = document.getElementById('risk-fill');
        list.innerHTML = '';
        
        let contractTotal = 0;
        state_slots[current_slot_idx].sort((a,b)=>a.diff-b.diff).forEach(i => {
            contractTotal += i.diff;
            const d = document.createElement('div');
            d.style = "font-size:11px; padding:5px 0; border-bottom:1px solid #222;";
            d.innerHTML = `<span style="color:var(--ak-red)">[LV.${i.diff}]</span> ${i.name}`;
            list.appendChild(d);
        });

        // 計算懲罰分數
        const penalty = calculateRescanPenalty(rescan_count);
        
        // 總分 = 合約 + 地圖 + 懲罰
        const finalTotal = contractTotal + state_map_risk + penalty;

        const riskVal = document.getElementById('total-risk');
        riskVal.innerText = finalTotal < 0 ? finalTotal : finalTotal.toString().padStart(2, '0');
        
        // 視覺化回饋：顯示重抽次數
        if (rescan_count > 0) {
            const pText = penalty >= 0 ? `+${penalty}` : `${penalty}`;
            riskVal.innerHTML += `<span style="font-size:12px; margin-left:10px; vertical-align:middle; color:#666;">(SCAN_SYNC: ${pText})</span>`;
        }

        riskVal.style.color = finalTotal < 0 ? "var(--ak-cyan)" : "var(--ak-yellow)";
        riskFill.style.width = Math.max(0, Math.min(100, (finalTotal / 30) * 100)) + "%";
    }

    // --- 地圖與 UI 保持原樣 ---
    function acquireTarget() {
        if(db_locations.length === 0) return;
        const roll = db_locations[Math.floor(Math.random() * db_locations.length)];
        document.getElementById('target-display').innerText = roll.name;
        state_map_risk = roll.risk;
        updateSidebarUI();
    }

    // (其餘 renderResultGrid, toggleLockLocal, switchSlot 等函數保持 9.2 原樣不變)


