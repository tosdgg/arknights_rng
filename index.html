<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRTS // Recruitment Terminal v3.5</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: rgba(30, 30, 30, 0.95);
            --ak-yellow: #ffcd00; 
            --ak-cyan: #23c7d6;   
            --ak-white: #f5f5f5;
            --ak-gray: #888;
            --ak-dark: #111;
            --font-mono: 'Courier New', Courier, monospace;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--ak-white);
            font-family: sans-serif;
            height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .container {
            width: 95%; max-width: 1100px; height: 85vh;
            background: var(--panel-bg);
            border: 1px solid #444;
            display: flex; flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .header-bar {
            height: 50px; background: #000; border-bottom: 3px solid var(--ak-yellow);
            display: flex; align-items: center; padding: 0 20px; justify-content: space-between;
        }

        .screen { padding: 40px; display: none; flex-direction: column; flex: 1; overflow-y: auto; }
        .screen.active { display: flex; }

        /* Buttons & Tags */
        .diff-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-top: 50px; }
        .ak-btn {
            background: #222; border: 1px solid #444; color: #fff; padding: 30px;
            cursor: pointer; transition: 0.2s; text-align: center; font-family: var(--font-mono);
        }
        .ak-btn:hover { background: var(--ak-yellow); color: #000; }

        .tag-grid { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
        .tag-btn {
            background: #333; color: #ccc; border: none; padding: 10px 20px;
            cursor: pointer; font-weight: bold; position: relative; transition: 0.1s;
        }
        
        /* 白色選取狀態 */
        .tag-btn.active { background: var(--ak-white); color: #000; }
        
        /* 黃色互斥狀態 */
        .tag-btn.exclusive { 
            background: var(--ak-yellow) !important; color: #000 !important; 
            box-shadow: 0 0 10px rgba(255,205,0,0.5);
        }
        .tag-btn.exclusive::after {
            content: 'UNIQUE'; position: absolute; top: -10px; left: 0;
            font-size: 9px; background: var(--ak-yellow); padding: 0 3px; color: #000;
        }

        .action-btn {
            background: var(--ak-cyan); color: #000; padding: 15px 40px;
            border: none; font-weight: bold; cursor: pointer; font-size: 1.1rem;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }

        .back-btn {
            position: absolute; top: 20px; right: 20px;
            background: transparent; border: 1px solid #666; color: #666;
            padding: 5px 15px; cursor: pointer; z-index: 10; font-family: var(--font-mono);
        }
        .back-btn:hover { border-color: #fff; color: #fff; }

        /* Results */
        .result-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; margin-top: 20px; }
        .result-card {
            background: rgba(0,0,0,0.6); border-left: 4px solid var(--ak-cyan);
            padding: 15px; display: flex; flex-direction: column; gap: 5px;
            animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        .tag-badge { font-size: 0.7rem; color: var(--ak-cyan); background: #222; padding: 2px 5px; margin-right: 4px; }

        #loader {
            position: absolute; inset: 0; background: #000; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-bar">
            <div style="font-family: var(--font-mono); color: var(--ak-yellow); font-weight: bold;">RHODES ISLAND // PRTS RECRUITMENT</div>
            <div id="connection-status" style="font-size: 0.8rem; color: var(--ak-cyan);">STATUS: CONNECTING...</div>
        </div>

        <div id="loader">
            <div style="letter-spacing: 5px; font-weight: bold;">SYNCHRONIZING</div>
            <div style="font-family: var(--font-mono); font-size: 10px; color: #555; margin-top: 5px;">ACCESSING NEURAL NETWORK...</div>
        </div>

        <div id="screen-difficulty" class="screen">
            <h1 style="border-left: 5px solid var(--ak-yellow); padding-left: 15px; letter-spacing: 2px;">SELECT MISSION LEVEL</h1>
            <div class="diff-grid">
                <div class="ak-btn" onclick="selectDifficulty(1)">LEVEL 01</div>
                <div class="ak-btn" onclick="selectDifficulty(2)">LEVEL 02</div>
                <div class="ak-btn" onclick="selectDifficulty(3)">LEVEL 03</div>
                <div class="ak-btn" onclick="selectDifficulty(4)">LEVEL 04</div>
                <div class="ak-btn" onclick="selectDifficulty(5)">LEVEL 05</div>
            </div>
        </div>

        <div id="screen-selector" class="screen">
            <button class="back-btn" onclick="goBack()">ABORT MISSION //</button>
            <h2 id="level-title" style="margin-top: 0;">CONFIGURATION</h2>
            
            <div style="color: var(--ak-gray); font-size: 0.8rem; font-family: var(--font-mono);">[ TAG SELECTION ] - 點擊切換：普通(白) / 唯一(黃) / 取消</div>
            <div id="tag-container" class="tag-grid"></div>

            <div style="margin: 20px 0; border-top: 1px solid #333; padding-top: 20px; display: flex; align-items: center;">
                <div style="display:flex; flex-direction:column;">
                    <label style="font-size: 0.7rem; color: var(--ak-gray); font-family: var(--font-mono);">QUANTITY //</label>
                    <input type="number" id="select-count" value="1" min="1" max="20" style="background:#000; color:#fff; border:none; border-bottom: 2px solid #fff; padding:5px; width:80px; font-size: 1.2rem; font-family: var(--font-mono);">
                </div>
                <button class="action-btn" onclick="startSelection()" style="margin-left: 40px;">START DEPLOYMENT</button>
            </div>

            <div id="result-container" class="result-container"></div>
        </div>
    </div>

    <script>
        // 配置你的 Google Sheet CSV 連結
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?output=csv";
        
        let allData = [];
        let currentLevelData = [];
        let tagStates = {}; // 0:無, 1:普通, 2:互斥

        // 初始化讀取
        window.onload = async () => {
            try {
                const res = await fetch(GOOGLE_SHEET_URL);
                if (!res.ok) throw new Error("Fetch failed");
                const text = await res.text();
                const rows = text.split(/\r?\n/).slice(1);
                
                allData = rows.map(r => {
                    const c = r.split(',');
                    if (c.length < 2) return null;
                    return { 
                        name: c[0]?.trim(), 
                        diff: parseInt(c[1]), 
                        tag: c[2] ? c[2].trim() : "其他" 
                    };
                }).filter(i => i && i.name);

                document.getElementById('loader').style.display = 'none';
                document.getElementById('screen-difficulty').classList.add('active');
                document.getElementById('connection-status').innerText = "STATUS: ONLINE";
            } catch (e) {
                document.getElementById('loader').innerText = "CONNECTION ERROR: Check Console";
                console.error(e);
            }
        };

        // 選擇難度並解析多標籤
        function selectDifficulty(lv) {
            currentLevelData = allData.filter(i => i.diff === lv);
            if (currentLevelData.length === 0) {
                alert("該難度暫無數據");
                return;
            }

            document.getElementById('screen-difficulty').classList.remove('active');
            document.getElementById('screen-selector').classList.add('active');
            document.getElementById('level-title').innerText = `OPERATION LEVEL 0${lv}`;
            
            // 重置狀態
            tagStates = {};
            document.getElementById('result-container').innerHTML = '';

            // 解析該等級所有出現過的標籤 (支援空格隔開的多標籤)
            let rawTags = [];
            currentLevelData.forEach(item => {
                const splitTags = item.tag.split(/\s+/); 
                rawTags = rawTags.concat(splitTags);
            });
            const tags = [...new Set(rawTags)].filter(t => t !== "");

            const container = document.getElementById('tag-container');
            container.innerHTML = '';

            tags.forEach(t => {
                const btn = document.createElement('button');
                btn.className = 'tag-btn';
                btn.innerText = t;
                btn.onclick = () => {
                    // 三態切換邏輯
                    if (!tagStates[t]) {
                        tagStates[t] = 1; btn.classList.add('active');
                    } else if (tagStates[t] === 1) {
                        tagStates[t] = 2; btn.classList.remove('active'); btn.classList.add('exclusive');
                    } else {
                        delete tagStates[t]; btn.classList.remove('exclusive');
                    }
                };
                container.appendChild(btn);
            });
        }

        // 重置與返回
        function goBack() {
            document.getElementById('screen-selector').classList.remove('active');
            document.getElementById('screen-difficulty').classList.add('active');
            tagStates = {};
            document.getElementById('result-container').innerHTML = '';
            document.getElementById('select-count').value = 1;
        }

        // 輔助函式：檢查項目是否包含某個標籤
        function hasTag(item, targetTag) {
            if (!item.tag) return false;
            const itemTags = item.tag.split(/\s+/);
            return itemTags.includes(targetTag);
        }

        // 執行隨機抽取
        function startSelection() {
            const count = parseInt(document.getElementById('select-count').value) || 1;
            let results = [];
            const selectedKeys = Object.keys(tagStates);
            const resContainer = document.getElementById('result-container');
            resContainer.innerHTML = '';

            if (selectedKeys.length === 0) {
                // 若無選標籤，則從該難度全抽
                results = [...currentLevelData];
            } else {
                const exTags = selectedKeys.filter(k => tagStates[k] === 2);
                const normalTags = selectedKeys.filter(k => tagStates[k] === 1);

                // 1. 處理黃色 (每個標籤僅出一個)
                exTags.forEach(t => {
                    const matches = currentLevelData.filter(item => hasTag(item, t));
                    if (matches.length) {
                        const randomOne = matches[Math.floor(Math.random() * matches.length)];
                        if (!results.includes(randomOne)) results.push(randomOne);
                    }
                });

                // 2. 處理白色 (普通聯集池)
                if (normalTags.length > 0) {
                    const pool = currentLevelData.filter(item => {
                        const isMatch = normalTags.some(t => hasTag(item, t));
                        return isMatch && !results.includes(item);
                    });
                    results = [...results, ...pool];
                }
            }

            // 洗牌並依照需求數量取樣
            const final = results.sort(() => 0.5 - Math.random()).slice(0, count);
            
            if (final.length === 0) {
                resContainer.innerHTML = '<div style="color:var(--ak-yellow)">NO MATCHING DATA FOUND</div>';
                return;
            }

            final.forEach((i, idx) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = 'result-card';
                    
                    // 如果該項目的標籤中有包含任何「黃色選中標籤」，則框線變黃
                    const containsEx = selectedKeys.filter(k => tagStates[k] === 2).some(t => hasTag(i, t));
                    if (containsEx) div.style.borderColor = 'var(--ak-yellow)';

                    // 生成標籤小徽章
                    const badges = i.tag.split(/\s+/).map(t => `<span class="tag-badge">${t}</span>`).join('');

                    div.innerHTML = `
                        <div style="font-weight:bold; font-size:1.1rem; letter-spacing:1px;">${i.name}</div>
                        <div>${badges}</div>
                    `;
                    resContainer.appendChild(div);
                }, idx * 50);
            });
        }
    </script>
</body>
</html>
