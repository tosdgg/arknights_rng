<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRTS // TACTICAL TERMINAL v8.0</title>
    <style>
        /* 保留 v7.0 所有酷炫樣式 */
        :root {
            --ak-red: #ff3e3e;
            --ak-yellow: #ffcd00; 
            --ak-cyan: #00e5ff;   
            --bg-dark: #050505;
            --font-mono: 'Consolas', 'Courier New', monospace;
        }
        body, html { margin: 0; padding: 0; background: var(--bg-dark); color: #fff; font-family: var(--font-mono); overflow: hidden; height: 100vh; }
        .bg-fx { position: fixed; inset: 0; z-index: -1; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%), radial-gradient(circle, #222 1px, transparent 1px); background-size: 100% 4px, 30px 30px; opacity: 0.3; }
        .container { width: 100vw; height: 100vh; display: flex; flex-direction: column; position: relative; }
        
        /* 側邊欄升級 */
        .sidebar {
            position: fixed; left: -300px; top: 50px; bottom: 0; width: 320px;
            background: rgba(8, 8, 8, 0.98); border-right: 2px solid var(--ak-red);
            transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1); z-index: 99;
            display: flex; flex-direction: column;
        }
        .sidebar:hover { left: 0; }
        .sidebar-handle {
            position: absolute; right: 0; top: 0; bottom: 0; width: 25px;
            background: repeating-linear-gradient(45deg, #000, #000 10px, #1a0000 10px, #1a0000 20px);
            border-left: 1px solid #333; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .sidebar-handle::after { content: "SCANNER"; writing-mode: vertical-rl; color: var(--ak-red); font-size: 10px; letter-spacing: 5px; opacity: 0.5; }

        /* 戰場定位器樣式 */
        .location-scanner {
            padding: 20px; background: rgba(255, 62, 62, 0.05); border-bottom: 1px solid #333; margin-bottom: 10px;
        }
        .locate-btn {
            width: 100%; background: transparent; border: 1px solid var(--ak-cyan); color: var(--ak-cyan);
            padding: 10px; cursor: pointer; font-family: var(--font-mono); font-size: 12px; margin-top: 10px;
        }
        .locate-btn:hover { background: var(--ak-cyan); color: #000; }
        .target-display {
            font-size: 1.2rem; font-weight: bold; color: #fff; margin: 10px 0; min-height: 1.5em;
            border-left: 3px solid var(--ak-cyan); padding-left: 10px;
        }

        /* 其他原有樣式保留... (此處省略部分重複 CSS 以節省空間，請對照 v7.0) */
        .status-bar { height: 50px; background: #000; border-bottom: 2px solid var(--ak-red); display: flex; align-items: center; padding: 0 25px; justify-content: space-between; z-index: 100; }
        .screen { padding: 40px; display: none; flex: 1; overflow-y: auto; margin-left: 20px; }
        .screen.active { display: flex; flex-direction: column; }
        .diff-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-top: 50px; }
        .diff-btn { background: #111; border: 1px solid #333; height: 180px; cursor: pointer; position: relative; clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%); }
        .diff-btn .val { font-size: 4rem; font-weight: 900; color: var(--ak-red); position: absolute; bottom: 10px; right: 20px; opacity: 0.7; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 10px; margin: 25px 0; }
        .tag-btn { background: #222; border: none; color: #888; padding: 8px 18px; cursor: pointer; clip-path: polygon(0 0, 90% 0, 100% 30%, 100% 100%, 0 100%); }
        .tag-btn.active { background: #fff; color: #000; }
        .tag-btn.exclusive { background: var(--ak-yellow); color: #000; }
        .action-btn { background: var(--ak-red); color: #fff; padding: 15px 50px; border: none; font-size: 1.2rem; font-weight: 900; cursor: pointer; clip-path: polygon(5% 0, 100% 0, 95% 100%, 0% 100%); }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 30px; }
        .contract-card { background: #111; border: 1px solid #333; border-left: 6px solid var(--ak-red); padding: 20px; position: relative; cursor: pointer; transition: 0.3s; }
        .contract-card.locked { border-left-color: var(--ak-cyan); background: #0a151a; box-shadow: 0 0 15px rgba(0, 229, 255, 0.1); }
        .contract-card.unique { border-left-color: var(--ak-yellow); }
        .side-locked-item { font-size: 12px; padding: 10px; border-bottom: 1px solid #222; color: #ccc; }
        .back-btn { background: transparent; border: 1px solid #444; color: #888; padding: 5px 15px; cursor: pointer; }
    </style>
</head>
<body>

<div class="bg-fx"></div>

<div class="container">
    <div class="status-bar">
        <div style="display:flex; align-items:center; gap:20px;">
            <span style="letter-spacing:3px; font-weight:bold; color:var(--ak-red);">PRTS // TACTICAL TERMINAL v8.0</span>
            <div id="abort-zone" style="display:none;"><button class="back-btn" onclick="goBack()">RETURN</button></div>
        </div>
        <div style="font-size:12px; color:var(--ak-cyan);">NEURAL_SYNC: ACTIVE</div>
    </div>

    <div class="sidebar">
        <div class="sidebar-handle"></div>
        <div class="sidebar-content">
            <div class="location-scanner">
                <div style="font-size:10px; color:var(--ak-cyan);">SIGNAL_LOCATOR</div>
                <div class="target-display" id="current-location">AWAITING_COORDINATES</div>
                <button class="locate-btn" onclick="acquireLocation()">ACQUIRE_TARGET</button>
                <div id="location-lock-status" style="font-size:10px; color:#555; margin-top:5px;">STATUS: UNLOCKED</div>
            </div>

            <div style="font-size:14px; color:var(--ak-cyan); margin: 10px 0; border-bottom:1px solid var(--ak-cyan);">LOCKED_CONTRACTS</div>
            <div id="sidebar-list">
                <div style="color:#444; font-size:12px;">NO_DATA_LOCKED</div>
            </div>
        </div>
        <div class="sidebar-footer">
            <div style="font-size:10px; color:#888;">TOTAL_RISK_INDEX</div>
            <div style="font-size:2.5rem; font-weight:900; color:var(--ak-yellow);" id="total-risk">00</div>
        </div>
    </div>

    <div id="screen-difficulty" class="screen active">
        <h1 style="font-size:2.5rem; margin:0; letter-spacing:5px;">MISSION_CONTROL</h1>
        <div class="diff-grid" id="diff-grid"></div>
    </div>

    <div id="screen-selector" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="level-title" style="margin:0; font-size:2rem; color:var(--ak-red);">LV.01</h2>
            <div>
                <span style="font-size:12px; color:#555;">SCAN_QTY</span>
                <input type="number" id="select-count" value="1" min="1" max="10" style="background:transparent; border:none; border-bottom:1px solid #fff; color:#fff; font-size:1.5rem; width:50px; text-align:center; outline:none;">
            </div>
        </div>
        <div class="tag-container" id="tag-container"></div>
        <button class="action-btn" onclick="startSelection()">START_SCAN</button>
        <div class="result-grid" id="result-container"></div>
    </div>
</div>

<script>
    // 請將你的第二個分頁 (關卡庫) 的 CSV 網址填入下方
    const CONTRACTS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?gid=0&output=csv";
    const LOCATIONS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?gid=你的第二頁GID&output=csv";

    let allContracts = [];
    let allLocations = [];
    let currentLevelData = [];
    let tagStates = {};
    let globalLocked = [];
    let lockedLocation = null;

    window.onload = async () => {
        await loadData();
        renderDiffButtons();
    };

    async function loadData() {
        try {
            const [cRes, lRes] = await Promise.all([fetch(CONTRACTS_URL), fetch(LOCATIONS_URL)]);
            const cText = await cRes.text();
            const lText = await lRes.text();

            allContracts = cText.split(/\r?\n/).slice(1).map((r, idx) => {
                const c = r.split(',');
                return { name: c[0]?.trim(), diff: parseInt(c[1]), tag: c[2]?.trim() || "其他", row: idx + 2 };
            }).filter(i => i.name);

            allLocations = lText.split(/\r?\n/).slice(1).map(r => r.split(',')[0]?.trim()).filter(i => i);
        } catch (e) { console.error("Data Load Fail"); }
    }

    function renderDiffButtons() {
        const grid = document.getElementById('diff-grid');
        grid.innerHTML = '';
        for(let i=1; i<=5; i++){
            const btn = document.createElement('div');
            btn.className = 'diff-btn';
            btn.innerHTML = `<div class="val">0${i}</div>`;
            btn.onclick = () => selectDifficulty(i);
            grid.appendChild(btn);
        }
    }

    function acquireLocation() {
        if(lockedLocation) {
            lockedLocation = null;
            document.getElementById('location-lock-status').innerText = "STATUS: UNLOCKED";
            document.getElementById('location-lock-status').style.color = "#555";
            return;
        }
        if(allLocations.length === 0) return;
        const target = allLocations[Math.floor(Math.random() * allLocations.length)];
        document.getElementById('current-location').innerText = target;
        lockedLocation = target;
        document.getElementById('location-lock-status').innerText = "STATUS: LOCKED";
        document.getElementById('location-lock-status').style.color = "var(--ak-cyan)";
    }

    function selectDifficulty(lv) {
        currentLevelData = allContracts.filter(i => i.diff === lv);
        document.getElementById('screen-difficulty').classList.remove('active');
        document.getElementById('screen-selector').classList.add('active');
        document.getElementById('abort-zone').style.display = 'block';
        document.getElementById('level-title').innerText = `LV_0${lv}_PROCESS`;
        tagStates = {};
        renderTags();
        renderResults(globalLocked.filter(l => currentLevelData.some(c => c.row === l.row)));
    }

    function renderTags() {
        let tags = [...new Set(currentLevelData.flatMap(i => i.tag.split(/\s+/)))].filter(t => t);
        const container = document.getElementById('tag-container');
        container.innerHTML = '';
        tags.forEach(t => {
            const btn = document.createElement('button');
            btn.className = 'tag-btn';
            btn.innerText = t;
            btn.onclick = () => {
                if(!tagStates[t]) { tagStates[t]=1; btn.classList.add('active'); }
                else if(tagStates[t]===1) { tagStates[t]=2; btn.classList.remove('active'); btn.classList.add('exclusive'); }
                else { delete tagStates[t]; btn.classList.remove('exclusive'); }
            };
            container.appendChild(btn);
        });
    }

    function toggleLock(item) {
        const idx = globalLocked.findIndex(l => l.row === item.row);
        if (idx > -1) globalLocked.splice(idx, 1);
        else globalLocked.push(item);
        updateSidebar();
    }

    function updateSidebar() {
        const list = document.getElementById('sidebar-list');
        const riskEl = document.getElementById('total-risk');
        list.innerHTML = '';
        let total = 0;
        globalLocked.forEach(item => {
            total += item.diff;
            const div = document.createElement('div');
            div.className = 'side-locked-item';
            div.innerHTML = `<span style="color:var(--ak-red)">[LV.${item.diff}]</span> ${item.name}`;
            list.appendChild(div);
        });
        riskEl.innerText = total.toString().padStart(2, '0');
    }

    function startSelection() {
        const count = parseInt(document.getElementById('select-count').value) || 1;
        let finalResults = [...globalLocked];
        
        const needed = count - finalResults.length;
        if (needed > 0) {
            const exTags = Object.keys(tagStates).filter(k => tagStates[k] === 2);
            const normalTags = Object.keys(tagStates).filter(k => tagStates[k] === 1);
            let pool = [];

            exTags.forEach(t => {
                const matches = currentLevelData.filter(i => i.tag.split(/\s+/).includes(t) && !finalResults.some(f => f.row === i.row));
                if(matches.length) {
                    const pick = matches[Math.floor(Math.random() * matches.length)];
                    pick._isUnique = true;
                    pool.push(pick);
                }
            });

            let remaining = needed - pool.length;
            if (remaining > 0) {
                let candidates = currentLevelData.filter(i => !finalResults.some(f => f.row === i.row) && !pool.some(p => p.row === i.row));
                if (Object.keys(tagStates).length > 0) {
                    candidates = candidates.filter(i => normalTags.some(t => i.tag.split(/\s+/).includes(t)));
                }
                pool = [...pool, ...candidates.sort(() => 0.5 - Math.random()).slice(0, remaining)];
            }
            finalResults = [...finalResults, ...pool];
        }
        renderResults(finalResults.slice(0, count));
    }

    function renderResults(items) {
        const container = document.getElementById('result-container');
        container.innerHTML = '';
        items.forEach(item => {
            const isLocked = globalLocked.some(l => l.row === item.row);
            const div = document.createElement('div');
            div.className = `contract-card ${item._isUnique ? 'unique' : ''} ${isLocked ? 'locked' : ''}`;
            div.innerHTML = `
                <div style="font-size:10px; color:#555;">>> ROW-${item.row} ${isLocked ? '[LOCKED]' : ''}</div>
                <div style="font-weight:bold; font-size:1.1rem; margin:10px 0;">${item.name}</div>
                <div style="font-size:10px; color:var(--ak-cyan);">TAG: ${item.tag}</div>
            `;
            div.onclick = () => { toggleLock(item); renderResults(items); };
            container.appendChild(div);
        });
    }

    function goBack() {
        document.getElementById('screen-selector').classList.remove('active');
        document.getElementById('screen-difficulty').classList.add('active');
        document.getElementById('abort-zone').style.display = 'none';
    }
</script>
</body>
</html>
