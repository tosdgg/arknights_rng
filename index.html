<script>
    const CONTRACT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?gid=0&output=csv";
    const LOCATION_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcai40JqQblGoCCGQqcubG9qDhhbJg3E-l6WoIQaVSpbvWw13pn4A0ilOdGjZ-j50dKNRHI7BneAmc/pub?gid=754158994&output=csv";

    let db_contracts = [], db_locations = [];
    let state_slots = [[], [], []], current_slot_idx = 0;
    
    // --- v9.52 新增：跨難度狀態追蹤 ---
    // 用於記錄每個 Slot(3個) 裡面每個難度(5級) 的隨機結果與重抽次數
    let state_history = [
        { results: {1:[],2:[],3:[],4:[],5:[]}, rescans: {1:0,2:0,3:0,4:0,5:0} },
        { results: {1:[],2:[],3:[],4:[],5:[]}, rescans: {1:0,2:0,3:0,4:0,5:0} },
        { results: {1:[],2:[],3:[],4:[],5:[]}, rescans: {1:0,2:0,3:0,4:0,5:0} }
    ];

    let current_lv = 0, state_map_risk = 0;
    const LV_QTY_MAP = { 1: 10, 2: 8, 3: 8, 4: 5, 5: 4 };

    window.onload = async () => { await initSystem(); };

    async function initSystem() {
        try {
            const [cRes, lRes] = await Promise.all([fetch(CONTRACT_URL), fetch(LOCATION_URL)]);
            const cText = await cRes.text(), lText = await lRes.text();
            db_contracts = cText.split(/\r?\n/).slice(1).map((r, idx) => {
                const cols = r.split(',');
                return { name: cols[0]?.trim(), diff: parseInt(cols[1]), row: idx + 2 };
            }).filter(i => i.name && !isNaN(i.diff));
            db_locations = lText.split(/\r?\n/).slice(1).map(r => {
                const cols = r.split(',');
                return { name: cols[0]?.trim(), risk: parseInt(cols[1]) || 0 };
            }).filter(i => i.name);
        } catch (e) { console.error("PRTS: SYNC_ERROR"); }
    }

    function startSystem() {
        document.getElementById('screen-cover').style.display = 'none';
        document.getElementById('screen-diff').classList.add('active');
        renderDifficultyCards();
    }

    function renderDifficultyCards() {
        const container = document.getElementById('diff-container');
        container.innerHTML = '';
        for(let i=1; i<=5; i++) {
            const score = state_slots[current_slot_idx].filter(it => it.diff === i).reduce((s, it) => s + it.diff, 0);
            const card = document.createElement('div');
            card.className = 'diff-card';
            card.innerHTML = `
                <div style="font-size:4rem; font-weight:900; color:var(--ak-red); position:absolute; bottom:5px; right:15px; opacity:0.1;">0${i}</div>
                <div style="padding:20px;">
                    <div style="font-size:10px; color:#666;">LV.0${i}_ACCUMULATED</div>
                    <div style="font-size:2rem; font-weight:bold; color:${score>0?'var(--ak-red)':(score<0?'var(--ak-cyan)':'#444')}">${score!==0?(score>0?'+'+score:score):'---'}</div>
                </div>
            `;
            card.onclick = () => enterLevel(i);
            container.appendChild(card);
        }
    }

    function enterLevel(lv) {
        current_lv = lv;
        const hist = state_history[current_slot_idx];
        
        document.getElementById('screen-diff').classList.remove('active');
        document.getElementById('screen-draw').classList.add('active');
        document.getElementById('back-zone').style.display = 'block';
        document.getElementById('current-lv-label').innerText = `RISK_LEVEL_0${lv}`;
        document.getElementById('draw-count').value = LV_QTY_MAP[lv];

        // 恢復之前的隨機結果
        if (hist.results[lv].length > 0) {
            // 如果這難度之前抽過，顯示當時的結果
            renderResultGrid(hist.results[lv]);
            // 並且如果已經點過 NEURAL_SCAN，鎖定按鈕
            document.getElementById('btn-scan').disabled = true;
        } else {
            // 如果是全新的難度，清空畫面並恢復按鈕
            document.getElementById('result-zone').innerHTML = '';
            document.getElementById('btn-scan').disabled = false;
        }
        updateSidebarUI();
    }

    function executeScan(isReroll) {
        const hist = state_history[current_slot_idx];
        
        if (!isReroll) {
            document.getElementById('btn-scan').disabled = true;
            hist.rescans[current_lv] = 0;
        } else {
            hist.rescans[current_lv]++;
        }

        const qty = LV_QTY_MAP[current_lv];
        // 找出目前「畫面中」被「鎖定到 SLOT」的合約
        let lockedInCurrent = hist.results[current_lv].filter(i => state_slots[current_slot_idx].some(s => s.row === i.row));
        
        // 從資料庫抽取，排除「已經被任何難度鎖定」的合約
        let pool = db_contracts.filter(i => i.diff === current_lv && !state_slots[current_slot_idx].some(s => s.row === i.row))
                     .sort(() => 0.5 - Math.random())
                     .slice(0, Math.max(0, qty - lockedInCurrent.length));
        
        // 更新歷史紀錄
        hist.results[current_lv] = [...lockedInCurrent, ...pool];
        
        renderResultGrid(hist.results[current_lv]);
        updateSidebarUI();
    }

    function renderResultGrid(items) {
        const zone = document.getElementById('result-zone');
        zone.innerHTML = '';
        items.forEach(item => {
            const isLocked = state_slots[current_slot_idx].some(s => s.row === item.row);
            const card = document.createElement('div');
            card.className = `contract-card ${isLocked ? 'locked' : ''}`;
            card.innerHTML = `
                <div style="font-size:10px; color:#555;">>> ROW-${item.row} ${isLocked?'[LOCKED]':''}</div>
                <div style="font-weight:bold; margin-top:5px;">${item.name}</div>
            `;
            card.onclick = () => {
                let s = state_slots[current_slot_idx];
                let idx = s.findIndex(l => l.row === item.row);
                if(idx > -1) s.splice(idx, 1); else s.push(item);
                renderResultGrid(items); // 重新渲染當前畫面以更新鎖定樣式
                updateSidebarUI();
            };
            zone.appendChild(card);
        });
    }

    function updateSidebarUI() {
        const list = document.getElementById('sidebar-list');
        list.innerHTML = '';
        let contractTotal = 0;
        state_slots[current_slot_idx].sort((a,b)=>a.diff-b.diff).forEach(i => {
            contractTotal += i.diff;
            list.innerHTML += `<div style="font-size:11px; padding:4px 0; border-bottom:1px solid #222;"><span style="color:var(--ak-red)">[LV.${i.diff}]</span> ${i.name}</div>`;
        });

        // 彙總所有難度的重抽次數
        let totalRescanBonus = 0;
        const hist = state_history[current_slot_idx];
        for(let lv in hist.rescans) {
            let count = hist.rescans[lv];
            if(count > 0) totalRescanBonus += -Math.pow(2, count - 1);
        }
        
        let final = contractTotal + state_map_risk + totalRescanBonus;
        const riskVal = document.getElementById('total-risk');
        riskVal.innerText = final < 0 ? final : final.toString().padStart(2, '0');
        riskVal.style.color = final < 0 ? "var(--ak-cyan)" : "var(--ak-yellow)";
        
        if(totalRescanBonus !== 0) {
            riskVal.innerHTML += `<span style="font-size:12px; color:#555; margin-left:10px;">RESCAN_BONUS: ${totalRescanBonus}</span>`;
        }
        document.getElementById('risk-fill').style.width = Math.max(0, Math.min(100, (final/30)*100)) + "%";
    }

    function switchSlot(idx) {
        current_slot_idx = idx;
        document.querySelectorAll('.slot-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
        updateSidebarUI();
        if(document.getElementById('screen-diff').classList.contains('active')) renderDifficultyCards();
    }

    function goBack() {
        document.getElementById('screen-draw').classList.remove('active');
        document.getElementById('screen-diff').classList.add('active');
        document.getElementById('back-zone').style.display = 'none';
        renderDifficultyCards();
    }
</script>
